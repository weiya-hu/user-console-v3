var e=Object.defineProperty,a=Object.defineProperties,t=Object.getOwnPropertyDescriptors,s=Object.getOwnPropertySymbols,l=Object.prototype.hasOwnProperty,n=Object.prototype.propertyIsEnumerable,u=(a,t,s)=>t in a?e(a,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):a[t]=s;import{_ as i,e as r,I as o,C as c,J as d,K as p}from"./index.e45ab2da.js";import{H as m,C as f,q as v,g as y,b as g,o as h,I as x,a as b,w,V as O,J as S,W as j,B as I,av as _,aw as P}from"./vue.fa004e33.js";const L={class:"fc fcc"},q=(e=>(_("data-v-0a0c4490"),e=e(),P(),e))((()=>S("div",{class:"file_name"},"拖拽/点击上传",-1))),z=["innerHTML"];var C=i(m({props:{exnameList:{default:()=>[".jpg",".png",".jpeg",".JPG",".PNG",".JPEG"]},max:{default:1},msg:{default:""},maxSize:{default:2},imgList:{default:()=>[]},needDownload:{type:Boolean,default:!1},site:{default:"official_img"}},emits:["upOneSuccess","upAllSuccess","error","change","del"],setup(e,{expose:i,emit:m}){const _=e,P=()=>{if(_.imgList.length&&_.imgList.forEach(((e,a)=>{C.value.push({url:e,name:"",status:"success",uid:-a-1}),A.value.push({url:e,name:"",status:"success",uid:-a-1,upUrl:e})})),_.imgList.length>=_.max){document.querySelector(".el-upload--picture-card").style.display="none"}};f((()=>{v((()=>{P()}))}));const C=y([]),D=y(),E=(e,a)=>{if(!e.name||"fail"===e.status)return;const t=e.name.substring(e.name.lastIndexOf("."));if(-1===_.exnameList.indexOf(t))return D.value.handleRemove(e),void r("图片格式错误！");if(e.size&&e.size/1024/1024>_.maxSize)return D.value.handleRemove(e),void r(`图片文件大小不能超过${_.maxSize}M`);C.value=a;const s=document.querySelector(".el-upload--picture-card");C.value.length>=_.max&&(s.style.display="none");const l=e.name.substring(0,e.name.indexOf("."));m("change",l)},U=(e,a)=>{const t=A.value.findIndex((a=>a.upUrl===e.url||a.uid===e.uid));t>-1&&A.value.splice(t,1),C.value=a,m("del"),document.querySelector(".el-upload--picture-card").style.display="inline-flex"},J=e=>{const a=[];C.value.forEach((e=>{a.push(e.url)})),o(a,a.findIndex((a=>a===e.url)))},A=y([]),G=()=>{A.value.length===C.value.length&&A.value.length&&m("upAllSuccess",A.value.map((e=>e.upUrl)))},H=async(e,i)=>{if("success"===e.status||!e.raw)return;const r=await d({site:_.site});if(1==r.status){const c=e.name.substring(e.name.lastIndexOf(".")),d=new FormData,f={key:r.body.dir+"/"+r.body.uuid+c,OSSAccessKeyId:r.body.accessid,success_action_status:"200",policy:r.body.policy,signature:r.body.signature};if(_.needDownload){const a=i?i+c:e.name;f["Content-Disposition"]="attachment; filename="+encodeURIComponent(a)}for(const[e,a]of Object.entries(f))d.append(e,a);d.append("file",e.raw);if(200==(await p({url:r.body.host,method:"post",headers:{"Content-Type":"multipart/form-data;"},data:d})).status){const i=r.body.host+"/"+r.body.dir+"/"+r.body.uuid+c;return A.value.push((o=((e,a)=>{for(var t in a||(a={}))l.call(a,t)&&u(e,t,a[t]);if(s)for(var t of s(a))n.call(a,t)&&u(e,t,a[t]);return e})({},e),a(o,t({upUrl:i})))),G(),m("upOneSuccess",i,C.value.length),Promise.resolve(i)}return Promise.reject(e.name+"上传失败")}var o;return Promise.reject("获取上传配置失败")},K=e=>{1==_.max&&(D.value.clearFiles(),D.value.handleStart(e[0]))};return i({submit:async e=>{G();try{for(let a=0;a<C.value.length;a++){const t=C.value[a];A.value.findIndex((e=>t.uid===e.uid))>-1||await H(t,e).catch((e=>{throw C.value.splice(a,1),document.querySelector(".el-upload--picture-card").style.display="inline-flex",new Error(e)}))}}catch(a){m("error",a)}},clear:()=>{C.value.length=0,A.value.length=0,document.querySelector(".el-upload--picture-card").style.display="inline-flex"},imgs:C,sucImgs:A,setImgs:P}),(a,t)=>{const s=g("el-icon"),l=g("el-upload");return h(),x("div",{class:j(["media_upload flex",1==e.max?"one_up":"alls_up"])},[b(l,{ref_key:"upload",ref:D,drag:"",action:"#","auto-upload":!1,limit:e.max,multiple:e.max>1,"list-type":"picture-card","on-exceed":K,"on-change":E,"on-preview":J,"on-remove":U,accept:e.exnameList.join(","),class:"upbox","file-list":e.imgList.map((e=>({name:"",url:e})))},{default:w((()=>[O(a.$slots,"default",{},(()=>[S("div",L,[b(s,null,{default:w((()=>[b(I(c))])),_:1}),q])]),!0)])),_:3},8,["limit","multiple","accept","file-list"]),S("div",{class:"tips",innerHTML:e.msg},null,8,z)],2)}}}),[["__scopeId","data-v-0a0c4490"]]);export{C as K};
